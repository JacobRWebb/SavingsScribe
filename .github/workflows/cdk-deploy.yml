name: CDK Deploy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  validate:
    name: Validate Code
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
      lambdas-changed: ${{ steps.lambda-changes.outputs.changed }}
      lambdas-json: ${{ steps.lambda-changes.outputs.lambdas }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for change detection

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Detect Lambda changes
        id: lambda-changes
        shell: pwsh
        run: |
          .github/scripts/detect-lambda-changes.ps1 `
            -ComponentsFile "components.json" `
            -BaseRef "origin/${{ github.event.repository.default_branch }}"

      - name: Check for infrastructure changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  build-lambdas:
    name: Build and Upload Lambdas
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should-deploy == 'true' && needs.validate.outputs.lambdas-changed == 'true'
    permissions:
      id-token: write
      contents: read
    outputs:
      cdk-context: ${{ steps.generate-context.outputs.cdk_context }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get or Create S3 Bucket
        id: s3-bucket
        shell: pwsh
        run: |
          $accountId = aws sts get-caller-identity --query Account --output text
          $bucketName = "savingsscribe-lambda-deployments-$accountId"
          
          Write-Host "Checking if bucket exists: $bucketName"
          
          # Check if bucket exists
          $bucketExists = aws s3api head-bucket --bucket $bucketName 2>&1
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Bucket does not exist. Creating bucket..."
            aws s3api create-bucket --bucket $bucketName --region ${{ env.AWS_REGION }}
            
            # Enable versioning
            Write-Host "Enabling versioning on bucket..."
            aws s3api put-bucket-versioning --bucket $bucketName --versioning-configuration Status=Enabled
            
            Write-Host "Bucket created and versioning enabled"
          } else {
            Write-Host "Bucket already exists"
          }
          
          echo "bucket_name=$bucketName" >> $env:GITHUB_OUTPUT

      - name: Build and Upload Changed Lambdas
        shell: pwsh
        run: |
          $lambdasJson = '${{ needs.validate.outputs.lambdas-json }}'
          $lambdas = $lambdasJson | ConvertFrom-Json
          
          Write-Host "Building $($lambdas.lambdas.Count) Lambda function(s)"
          
          foreach ($lambda in $lambdas.lambdas) {
            Write-Host "`n=========================================="
            Write-Host "Processing: $($lambda.Name)"
            Write-Host "=========================================="
            
            .github/scripts/build-and-upload-lambda.ps1 `
              -LambdaName $lambda.Name `
              -LambdaPath $lambda.Path `
              -S3Bucket "${{ steps.s3-bucket.outputs.bucket_name }}" `
              -DotnetVersion "8.0"
          }

      - name: Generate CDK Context
        id: generate-context
        shell: pwsh
        run: |
          .github/scripts/generate-cdk-context.ps1 -MetadataDir "lambda-packages"

      - name: Upload Lambda Metadata
        uses: actions/upload-artifact@v4
        with:
          name: lambda-metadata
          path: lambda-packages/*-metadata.json
          retention-days: 7

  synth:
    name: CDK Synthesis
    runs-on: ubuntu-latest
    needs: [validate, build-lambdas]
    if: |
      always() && 
      needs.validate.outputs.should-deploy == 'true' &&
      (needs.build-lambdas.result == 'success' || needs.build-lambdas.result == 'skipped')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install AWS CDK Toolkit
        run: npm install -g aws-cdk@latest

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: CDK Synthesis
        run: |
          cdk synth --app "dotnet run --project ./SavingsScribe.Infrastructure/SavingsScribe.Infrastructure.csproj" --all

      - name: Upload CloudFormation templates
        uses: actions/upload-artifact@v4
        with:
          name: cdk-templates
          path: cdk.out/
          retention-days: 7

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [validate, build-lambdas, synth]
    if: |
      always() && 
      needs.validate.outputs.should-deploy == 'true' &&
      needs.synth.result == 'success'
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AWS CDK Toolkit
        run: npm install -g aws-cdk@latest

      - name: Download CloudFormation templates
        uses: actions/download-artifact@v4
        with:
          name: cdk-templates
          path: cdk.out/

      - name: Download Lambda Metadata
        if: needs.build-lambdas.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: lambda-metadata
          path: lambda-packages/
        continue-on-error: true

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Prepare CDK Context
        id: cdk-context
        shell: pwsh
        run: |
          $cdkContext = "${{ needs.build-lambdas.outputs.cdk-context }}"
          
          if ([string]::IsNullOrWhiteSpace($cdkContext)) {
            Write-Host "No CDK context from Lambda builds"
            echo "context_args=" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "CDK Context: $cdkContext"
            echo "context_args=$cdkContext" >> $env:GITHUB_OUTPUT
          }
        
      - name: CDK Deploy
        shell: pwsh
        run: |
          $contextArgs = "${{ steps.cdk-context.outputs.context_args }}"
          $cdkCommand = "cdk deploy --app `"dotnet run --project ./SavingsScribe.Infrastructure/SavingsScribe.Infrastructure.csproj`" --all --require-approval never"
          
          if (![string]::IsNullOrWhiteSpace($contextArgs)) {
            $cdkCommand = "$cdkCommand $contextArgs"
          }
          
          Write-Host "Executing: $cdkCommand"
          Invoke-Expression $cdkCommand
